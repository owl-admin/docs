"use strict";(self.webpackChunkrspress_doc_template=self.webpackChunkrspress_doc_template||[]).push([["3674"],{1915:function(e,n,r){r.r(n),r.d(n,{default:function(){return d}});var s=r(2676),t=r(453);function i(e){let n=Object.assign({h1:"h1",a:"a",p:"p",div:"div",code:"code",h2:"h2",pre:"pre",h3:"h3",ul:"ul",li:"li"},(0,t.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"数据导出",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#数据导出",children:"#"}),"数据导出"]}),"\n",(0,s.jsx)(n.p,{children:"框架提供了便捷的数据导出功能，支持 Excel 和 CSV 格式导出。"}),"\n",(0,s.jsxs)(n.div,{className:"rspress-directive info",children:[(0,s.jsx)(n.div,{className:"rspress-directive-title",children:"依赖说明"}),(0,s.jsx)(n.div,{className:"rspress-directive-content",children:(0,s.jsxs)(n.p,{children:["\nExcel 导出需要安装：",(0,s.jsx)(n.code,{children:"composer require rap2hpoutre/fast-excel"})]})})]}),"\n",(0,s.jsxs)(n.h2,{id:"使用",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#使用",children:"#"}),"使用"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",meta:"",children:"// 在列表工具栏添加导出按钮\npublic function list(): Page\n{\n    $crud = $this->baseCRUD()\n        ->headerToolbar([\n            $this->createButton(),\n            ...$this->baseHeaderToolBar(),\n            // 添加导出按钮\n            $this->exportAction(),\n        ])\n        ->columns([\n            // ...\n        ]);\n\n    return $this->baseList($crud);\n}\n\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"自定义导出信息",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#自定义导出信息",children:"#"}),"自定义导出信息"]}),"\n",(0,s.jsxs)(n.h3,{id:"导出文件名",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#导出文件名",children:"#"}),"导出文件名"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",meta:"",children:"// 在控制器中重写 exportFileName 方法\nprotected function exportFileName()\n{\n    return '此处为导出文件名';\n}\n"})}),"\n",(0,s.jsxs)(n.h3,{id:"导出列信息",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#导出列信息",children:"#"}),"导出列信息"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",meta:"",children:"// 在控制器中重写 exportMap 方法, $row 是数组格式\n// 该方法会被循环调用, 请不要在里面执行 IO 操作\nprotected function exportMap($row)\n{\n    return [\n        'ID' => $row['id'],\n        '用户名' => $row['username'],\n        '真实姓名' => $row['real_name'],\n        '邮箱' => $row['email'],\n        '部门' => $row['department']['name'] ?? '',\n        '状态' => $row['status'] ? '启用' : '禁用',\n        '创建时间' => date('Y-m-d H:i:s', strtotime($row['created_at'])),\n    ];\n}\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"完整自定义",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#完整自定义",children:"#"}),"完整自定义"]}),"\n",(0,s.jsxs)(n.p,{children:["如果以上配置不能满足你的需求, 你可以重写 ",(0,s.jsx)(n.code,{children:"export"})," 方法, 自定义导出逻辑"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",meta:"",children:"// 在控制器中重写 export 方法\n// 此方法在 index() 中被调用, 当请求参数 _action=export 时\nprotected function export()\n{\n    // 默认在 storage/app/ 下\n    $path = sprintf('%s-%s.xlsx', $this->exportFileName(), date('YmdHis'));\n\n    // 导出本页和导出选中项都是通过 _ids 查询\n    $ids = request()->input('_ids');\n\n    // listQuery() 为列表查询条件，与获取列表数据一致\n    $query = $this->service->listQuery()\n        ->when($ids, fn($query) => $query->whereIn($this->service->primaryKey(), explode(',', $ids)));\n\n    try {\n        fastexcel($query->get())->export(storage_path('app/' . $path), fn($row) => $this->exportMap($row));\n    } catch (\\Throwable $e) {\n        admin_abort(__('admin.action_failed'));\n    }\n\n    return $this->response()->success(compact('path'));\n}\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"多格式导出",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#多格式导出",children:"#"}),"多格式导出"]}),"\n",(0,s.jsx)(n.p,{children:"支持导出为不同格式："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",meta:"",children:"protected function export()\n{\n    $format = request('format', 'xlsx'); // 支持 xlsx, csv\n    $filename = $this->exportFileName() . '-' . date('YmdHis');\n\n    $ids = request()->input('_ids');\n    $query = $this->service->listQuery()\n        ->when($ids, fn($query) => $query->whereIn($this->service->primaryKey(), explode(',', $ids)));\n\n    switch ($format) {\n        case 'csv':\n            return $this->exportCsv($query, $filename);\n        default:\n            return $this->exportExcel($query, $filename);\n    }\n}\n\n/**\n * 导出 CSV\n */\nprotected function exportCsv($query, $filename)\n{\n    $path = \"exports/{$filename}.csv\";\n    $fullPath = storage_path(\"app/{$path}\");\n\n    // 确保目录存在\n    $directory = dirname($fullPath);\n    if (!is_dir($directory)) {\n        mkdir($directory, 0755, true);\n    }\n\n    $file = fopen($fullPath, 'w');\n\n    // 添加 BOM 头，解决中文乱码\n    fwrite($file, \"\\xEF\\xBB\\xBF\");\n\n    $isFirstRow = true;\n    $query->chunk(1000, function($rows) use ($file, &$isFirstRow) {\n        foreach ($rows as $row) {\n            $data = $this->exportMap($row->toArray());\n\n            if ($isFirstRow) {\n                fputcsv($file, array_keys($data)); // 写入表头\n                $isFirstRow = false;\n            }\n\n            fputcsv($file, array_values($data)); // 写入数据\n        }\n    });\n\n    fclose($file);\n\n    return $this->response()->success(['path' => $path]);\n}\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"大数据量处理",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#大数据量处理",children:"#"}),"大数据量处理"]}),"\n",(0,s.jsx)(n.p,{children:"处理大量数据时的优化方案："}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",meta:"",children:"protected function export()\n{\n    $query = $this->service->listQuery();\n    $count = $query->count();\n\n    // 大数据量分块处理\n    if ($count > 5000) {\n        return $this->exportLargeData($query);\n    }\n\n    // 小数据量直接导出\n    return $this->exportNormal($query);\n}\n\n/**\n * 大数据量导出\n */\nprotected function exportLargeData($query)\n{\n    $filename = $this->exportFileName() . '-' . date('YmdHis') . '.xlsx';\n    $path = \"exports/{$filename}\";\n    $fullPath = storage_path(\"app/{$path}\");\n\n    $directory = dirname($fullPath);\n    if (!is_dir($directory)) {\n        mkdir($directory, 0755, true);\n    }\n\n    $isFirstChunk = true;\n    $chunkSize = 1000;\n\n    $query->chunk($chunkSize, function($rows) use (&$isFirstChunk, $fullPath) {\n        $data = $rows->map(function($row) {\n            return $this->exportMap($row->toArray());\n        })->toArray();\n\n        if ($isFirstChunk) {\n            fastexcel($data)->export($fullPath);\n            $isFirstChunk = false;\n        } else {\n            fastexcel($data)->appendTo($fullPath);\n        }\n    });\n\n    return $this->response()->success(['path' => $path]);\n}\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"最佳实践",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#最佳实践",children:"#"}),"最佳实践"]}),"\n",(0,s.jsxs)(n.h3,{id:"1-性能优化",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#1-性能优化",children:"#"}),"1. 性能优化"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"大数据量使用分块处理（chunk）"}),"\n",(0,s.jsxs)(n.li,{children:["避免在 ",(0,s.jsx)(n.code,{children:"exportMap"})," 中执行数据库查询"]}),"\n",(0,s.jsx)(n.li,{children:"预加载必要的关联关系"}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"2-安全考虑",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#2-安全考虑",children:"#"}),"2. 安全考虑"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"控制导出数据量，避免内存溢出"}),"\n",(0,s.jsx)(n.li,{children:"验证用户导出权限"}),"\n",(0,s.jsx)(n.li,{children:"敏感数据脱敏处理"}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"3-用户体验",children:[(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#3-用户体验",children:"#"}),"3. 用户体验"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"提供清晰的文件命名"}),"\n",(0,s.jsx)(n.li,{children:"支持多种导出格式"}),"\n",(0,s.jsx)(n.li,{children:"大文件导出时显示进度提示"}),"\n"]})]})}function a(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,t.ah)(),e.components);return n?(0,s.jsx)(n,Object.assign({},e,{children:(0,s.jsx)(i,e)})):i(e)}let d=a;a.__RSPRESS_PAGE_META={},a.__RSPRESS_PAGE_META["guide%2Fcrud%2Fexport.md"]={toc:[{id:"使用",text:"使用",depth:2},{id:"自定义导出信息",text:"自定义导出信息",depth:2},{id:"导出文件名",text:"导出文件名",depth:3},{id:"导出列信息",text:"导出列信息",depth:3},{id:"完整自定义",text:"完整自定义",depth:2},{id:"多格式导出",text:"多格式导出",depth:2},{id:"大数据量处理",text:"大数据量处理",depth:2},{id:"最佳实践",text:"最佳实践",depth:2},{id:"1-性能优化",text:"1. 性能优化",depth:3},{id:"2-安全考虑",text:"2. 安全考虑",depth:3},{id:"3-用户体验",text:"3. 用户体验",depth:3}],title:"数据导出",frontmatter:{}}}}]);